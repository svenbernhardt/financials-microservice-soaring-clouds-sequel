box: maven:latest

dev:
  steps:
  #  - jakubriedl/docker-push:
  #      image: sbernhardtoc/financials-ms-1.0.0.0
  #      username: sbernhardtoc
  #      password: Diplompx01_
  #      email: sven.bernhardt@opitz-consulting.com
    - internal/docker-build:
        dockerfile: financials-ms/Dockerfile
        image-name: financials-ms-image
    - internal/docker-push:
        image-name: financials-ms-image
        username: $DOCKER_USERNAME
        password: $DOCKER_PASSWORD
        registry: https://docker.io
        repository: $USERNAME/financials-ms-1.0.0.0
        tag: latest

build:
  steps:
    # Build Spring Boot Sample application
    - script:
        name: Maven install
        code: mvn -f financials-ms/pom.xml install -DskipTests

test-api:
  box: node:8
  steps:
    - npm-install:
        options: --no-optional
    - script:
        name: print-dredd-version
        code: npm info dredd version
    #- script:
    #  name: configure-mongo
    #  code: export MONGO_URI="mongodb://$MONGO_PORT_27017_TCP_ADDR:$MONGO_PORT_27017_TCP_PORT"
    - npm-test
        #cwd: test/dredd

push-to-releases:
  box: openjdk:8-jre-alpine
  steps:
    - script:
        code: ls $WERCKER_SOURCE_DIR/financials-ms/target
    # Push to public docker repo Container Registry (CR)
    #- script:
    #  code: |
    #    mv $WERCKER_SOURCE_DIR/financials-ms/target/financials-microservice-1.0.0.0.jar ./financials-ms.jar
    #    touch ./financials-ms.jar
    #- internal/docker-build:
    #    dockerfile: financials-ms/Dockerfile
    #    image-name: financials-ms-image
    - internal/docker-push:
        #image-name: financials-ms-image
        username: $DOCKER_USERNAME
        password: $DOCKER_PASSWORD
        #registry: https://docker.io
        repository: $DOCKER_USERNAME/financials-ms-1.0.0.0
        cmd: java -Djava.security.egd=file:/dev/./urandom -jar $WERCKER_SOURCE_DIR/financials-ms/target/financials-ms.jar
        tag: latest
